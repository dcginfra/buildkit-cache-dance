name: Inject Cache
description: "Injects the cached data into the docker build(x|kit) process"
inputs:
  cache-source:
    default: cache
    description: "Where the cache is stored in the calling workspace. Default: `cache`"
  scratch-dir:
    default: scratch
    description: "Where the action is stores some temporary files for its processing. Default: `scratch`"
  mounts:
    description: Docker build cache mounts list
    required: true
  bucket:
    description: Bucket name
    required: true

runs:
  using: composite
  steps:
    - name: Clean Directories
      shell: bash
      run: |
        rm -Rf ${{ inputs.scratch-dir }} && mkdir -p ${{ inputs.scratch-dir }} ${{ inputs.cache-source }}

    - name: Prepare Timestamp for Layer Cache Busting
      shell: bash
      run: |
        date --iso=ns | tee ${{ inputs.cache-source }}/buildstamp

    - name: Prepare list of cache mounts for Dancefile
      uses: actions/github-script@v6
      id: mounts
      with:
        script: |
          const mountIds = `${{ inputs.mounts }}`.split(/[\r\n,]+/)
            .map((mount) => mount.trim())
            .filter((mount) => mount.length > 0);
          
          const cacheMountArgs = mountIds.map((mount) => (
            `--mount=type=cache,sharing=shared,id=${mount},target=/cache-mounts/${mount}`
          )).join(' ');
          
          const s5commands = mountIds.map((mount) => (
            `sync --no-follow-symlinks s3://${bucket}/cache-mounts/${mount}/* /cache-mounts/${mount}`
          )).join('\n');

          core.setOutput('cacheMountArgs', cacheMountArgs);
          core.setOutput('s5commands', s5commands);

    - name: Inject Data into buildx context
      shell: bash
      run: |
        docker build ${{ inputs.cache-source }} --file - <<EOF
        FROM peakcom/s5cmd:v2.1.0
        COPY buildstamp buildstamp
        RUN ${{ steps.mounts.outputs.cacheMountArgs }} <<EOT
            echo '${{ steps.mounts.outputs.s5commands }}' | /s5cmd --stat --log error run && \
            chmod 777 -R /cache-mounts || true && \
            find /cache-mounts -exec touch -d `date +%Y.%m.%d-%H:%M:%S -d@"$((\`date +%s\`-2))"` {} +
        EOT
        EOF

    - name: Clean Directories
      shell: bash
      run: |
        sudo rm -rf ${{ inputs.cache-source }}
